# 3-3. パラボラテレポーターの実装

![image][1073979588]

** 今回のサンプルシーンの場所 **
- git:// VR-studies/Asset/VR-studies/3_VR-teleporter/3-2_PointTeleporter

前章で作成したレーザーポインターでは、高い位置にあるポイントを選択しにくい、障害物の向こう側を選択できない、などの問題がありした。
今回はこの問題点を解決する放物線型のポインターを実装してみます。

このポインターでは、先端のカーソルが空間の高低差に合わせて自動でフォーカスすることで、プレイヤーの位置からは見えない高さの地点も指し示すことができます。
また目の前に障害物がある場合でも、放物線をうまく操作することで、その向こう側を指し示すことも可能です。
このタイプのポインターは高低差や障害物の多い空間でも機能するため、VIVEのデモアプリであるTheLabなどでも採用されています。

---
### 新規シーンの構築

新規シーンを作成したら、まずは前章の通りSteamVR Pluginをインポートして、[CameraRig]プレハブを配置後、MainCameraを削除します。

---
### ステージの作成

まずは床を作ります。シーンに適当な大きさで3D Object/Planeを追加してください。

前章と同じようにCubeを使用して障害物を作りますが、今回の移動方法ではワープできる場所を示すポイントは必要ありません。
ここでは下記のようなステージを作成してみました。

![image][1073979585]

---
### ParaboraTeleporter.csの作成

パラボラポインタを実装するスクリプトを作成します。Projectパネル内にParaboraTeleporterという名前でC#Scriptを作成し、
Hierarchyパネル上の[CameraRig]/Controller (right/left)オブジェクトにアタッチします。

まずワープ処理のため、前章と同じくSteamVR_FadeをCamera (eye)にアタッチしておきます。

```
void Start() {

	// カメラにSteamVR_Fadeスクリプトをアタッチ
	CameraRig = GameObject.Find ("[CameraRig]");
	CameraEye = CameraRig.transform.FindChild( "Camera (eye)" ).gameObject;
	CameraEye.AddComponent<SteamVR_Fade> ();

	SteamVR_TrackedObject trackedObject = transform.GetComponent<SteamVR_TrackedObject>();
	hand = SteamVR_Controller.Input( (int) trackedObject.index );
	head = SteamVR_Controller.Input( (int) SteamVR_TrackedObject.EIndex.Hmd );

...
```

次にポインターの放物線を表現するための各点をPrimitiveオブジェクトを使って作成しておきます。

```
GameObject cursor;
List<GameObject> paraboras = new List<GameObject>();
float paraboraMaxZ = 10.0f;

void Start() {

...

	// パラボラの各点を生成する
	CreateParaboraPoints();
}

void CreateParaboraPoints() {

	//ポイントを作成する
	for( int i = 0; i < 10; i++ ){
		var point = GameObject.CreatePrimitive(PrimitiveType.Sphere);
		point.transform.SetParent( transform, false );
		point.transform.localScale = new Vector3( 0.04f, 0.04f, 0.04f );
		point.GetComponent<MeshRenderer>().material.color = Color.yellow;
		Object.DestroyImmediate(point.GetComponent<SphereCollider>());
		paraboras.Add ( point );
	}

	//カーソルを作成する
	cursor = GameObject.CreatePrimitive(PrimitiveType.Sphere);
	cursor.transform.SetParent( transform, false );
	cursor.transform.localScale = new Vector3( 0.15f, 0.15f, 0.15f );
	cursor.GetComponent<MeshRenderer>().material.color = Color.red;
	Object.DestroyImmediate(cursor.GetComponent<SphereCollider>());
}

Vector3 GetParabolaPoint( Vector3 start, Vector3 end, float maxHeight, float t ) {

	// 開始と終点の3次元位置から放物線を計算する
	float tic = t * 2 - 1;
	Vector3 toDir = end - start;
	Vector3 ticDir = end - new Vector3( start.x, end.y, start.z );
	Vector3 right = Vector3.Cross( toDir, ticDir );
	Vector3 up = Vector3.Cross( right, ticDir );
	if ( end.y > start.y ) up = -up;
	Vector3 result = start + t * toDir;
	result += ( ( -tic * tic + 1 ) * maxHeight ) * up.normalized;
	return result;
}

```

---
### パラボラポインターの挙動

![image][1073979584]
![image][1073979583]

ポインターの具体的な挙動としては、まず何も障害物がない状態のときは、X軸の角度が０度のときに最も遠くを指し示すようにし、
上に傾けて90度に近づくほど、先端のカーソルが手前に向かってくるようにします。

前方に障害物がある場合は、まずカーソルとその障害物がヒットした場所にカーソル座標を合わせます。
さらにカーソルを床や障害物のXZ平面上に落とすために、カーソル座標の上空の十分に高い位置から真下にレイキャストして、
最初にヒットしたオブジェクトの表面のY座標とカーソルのY座標を合わせます。

最後にVIVEコントローラーとカーソルの座標を結ぶ放物線の軌道を計算し、いくつかのSphereオブジェクトをその軌道上に配置することでパラボラポインタを表現します。

```
bool CastParaboraPointer() {

	if( isTeleporting ){ return false; }
	bool hasHit = false;

	// コントローラーのX軸のアングルを -90 ～ 90度に変換
	var angleX = controller.transform.rot.eulerAngles.x;
	if( angleX <= 90 ){ angleX *= -1; }
	if( angleX >= 270 ){ angleX = 360 - angleX; }

	// 0度より上向きのとき
	if ( angleX > 0 ) {

		// 0度の時に最長になるようにカーソルの奥行を決定
		var endZ = ( 1.0f - angleX / 90.0f ) * paraboraMaxZ;
		cursor.transform.localPosition = new Vector3( 0.0f, 0.0f, endZ );
	}

	// コントローラー前方にレイキャストして衝突位置にカーソルを移動
	if ( Physics.Raycast ( transform.position, transform.forward, out hitInfo, paraboraMaxZ ) ) {
		cursor.transform.position = new Vector3( hitInfo.point.x, hitInfo.point.y + 0.1f, hitInfo.point.z );
	}else{
		cursor.transform.localPosition = new Vector3( 0.0f, 0.0f, paraboraMaxZ );
	}

	// カーソル位置上空から真下にレイキャストして衝突位置までカーソルのY位置を移動
	if ( Physics.Raycast ( new Vector3( cursor.transform.position.x, 10, cursor.transform.position.z ), Vector3.down, out hitInfo, 10 ) ) {
		cursor.transform.position = new Vector3( hitInfo.point.x, hitInfo.point.y + 0.1f, hitInfo.point.z );
		hasHit = true;
	}

	// カーソル位置まで各点の放物線軌跡を描く
	for( int i = 0; i < paraboras.Count; i++ ){
		var point = paraboras [i];
		point.transform.position = GetParabolaPoint( transform.position, cursor.transform.position, 2.0f, i * 0.1f );
		point.GetComponent<MeshRenderer> ().material.color = hasHit ? Color.yellow : Color.red;
	}

	return hasHit;
}
```

最後に、パラボラポインタが移動可能地点にヒットしている間にコントローラーのトリガーボタンが押されたら、
前章と同じようにSteamVR_Fadeを使用して該当地点にワープするようにします。

```
void FixedUpdate () {

	// パラボラポインタでヒットを検知する
	if ( CastParaboraPointer() ) {

		//トリガーを引いたらワープする
		if ( hand.GetPressDown( SteamVR_Controller.ButtonMask.Trigger ) ) {
			StartTeleport();
		}
	}
}

void StartTeleport() {

	// 画面をフェードアウトしてカメラの位置を変更した後にフェードイン
	isTeleporting = true;
	SteamVR_Fade.Start( new Color( 0, 0, 0 ), 0.3f, false );
	Invoke ( "EndTeleport", 0.3f );
}

void EndTeleport() {

	// ルームごと移動させるために、ターゲット座標とHMD座標との差分をCameraRigのポジションに適用
	CameraRig.transform.position = new Vector3 ( cursor.transform.position.x - head.transform.pos.x, hitInfo.point.y, cursor.transform.position.z - head.transform.pos.z );
	SteamVR_Fade.Start( Color.clear, 1.0f, false );
	isTeleporting = false;
}
```

---
### シーンの実行

シーンを実行し、コントローラーを傾けてパラボラポインターがどのように機能するか試してみてください。
操作に多少の慣れは必要ですが、高低差のある空間内の移動に関しては現状ベストな方法ではないかと思います。

![image][1073979588]

また、以下のサンプルシーンでは、前章で作成したPhysicsTeleporter.csを[CameraRig]にアタッチして、
高いところから踏み外した場合は自動落下する処理を入れています。



** 今回のサンプルシーンの場所 **
- git:// VR-studies/Asset/VR-studies/3_VR-teleporter/3-3_ParaboraTeleporter
