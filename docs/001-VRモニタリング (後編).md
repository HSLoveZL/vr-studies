# 001 - VRモニタリング（後編）

ここからは、実際にSteamVRプラグインを使用して、Unity上でVIVEのHMDおよびコントローラーの情報を取得して表示してみます。

![image][1073979541]

** 今回のサンプルシーンの場所 **

- git:// VR-studies/Asset/VR-studies/1_VR-monitor/Monitor.unity

---
### 新規シーンの構築

新規シーンを作成したら、まずは前章の通りSteamVR Pluginをインポートして、[CameraRig]プレハブを配置後、MainCameraを削除します。

---
### ステージの作成

まずは床を作ります。シーンに適当な大きさで3D Object/Planeを追加してください。

なおSteamVR空間内での基本単位は、現実空間と同じスケールのメートル単位となります。
HMDやVIVEコントローラーの位置情報もこの単位で取得されるので、ステージを作成する際はこの点に注意してください。

次にモニタリングした情報を表示するためのGUIパネルを作成します。

HMDの情報を表示するパネルは常にプレイヤーの視界中央に張り付くようにしたいので、HeadMonitorという名前でUI/Canvasオブジェクトを作成し、
[CameraRig]/Camera (head)の子に配置します。

![image][1073979542]

VIVEコントローラーの情報を表示するパネルは、常にそのコントローラーのモデルに張り付くようにしたいので、
それぞれ [CameraRig]/Camera (right) と [CameraRig]/Camera (left)の子に配置します。

![image][1073979543]


なおこの際、各Canvasの座標系はWorld Spaceに設定してください。

![image][1073979657]

---
### HeadMonitor.csの作成  

まずHMDデバイスの情報を取得するスクリプトを作成します。
Projectパネル内にHeadMonitorという名前でC#Scriptを作成し、先ほど作成したHeadMonitorオブジェクトにアタッチします。

前章で解説した通りに、SteamVR Pluginのスクリプトを使用してHMDデバイスの情報をトラックします。

```
public class HeadMonitor : MonoBehaviour {

	SteamVR_Controller.Device head = null;
	Text[] texts = null;

	float fps = 0;
	float fpsTime = 0;

	//------------------------------------------------------------------------------------------------------------------------------//
	void Start () {

		// グローバルからHMDデバイスの参照を取得
		head = SteamVR_Controller.Input( (int) SteamVR_TrackedObject.EIndex.Hmd );

		texts = transform.FindChild("Inputs").GetComponentsInChildren<Text>();
		fpsTime = Time.time;
	}

	void Update () {

		// FPSをトラックする
		TrackFPS();

		// Headの状態をトラックする
		TrackHead ();
	}

	//------------------------------------------------------------------------------------------------------------------------------//
	void TrackFPS () {
		fps += 1;
		if( Time.time >= fpsTime ){
			texts[0].text = "FPS : " + fps + "";
			fps = 0;
			fpsTime += 1;
		}
	}

	//------------------------------------------------------------------------------------------------------------------------------//
	void TrackHead () {
		SteamVR_Utils.RigidTransform Head_tr = head.transform;
		texts[1].text = "Position : " + Head_tr.pos + "";
		texts[2].text = "Rotation : (" + Mathf.RoundToInt (Head_tr.rot.eulerAngles.x) + " : " + Mathf.RoundToInt (Head_tr.rot.eulerAngles.y) + " : " + Mathf.RoundToInt (Head_tr.rot.eulerAngles.z) + ")";
	}
}
```
---
### HandMonitor.csの作成  

次にVIVEコントローラーデバイスの情報を取得するスクリプトを作成します。
Projectパネル内にHandMonitorという名前でC#Scriptを作成し、先ほど作成したHandMonitorオブジェクトにアタッチします。

前章で解説した通りに、SteamVR Pluginのスクリプトを使用してVIVEコントローラーデバイスの情報をトラックします。
このスクリプトはhandMonitorオブジェクトにアタッチされているため、this.transform.parentからSteamVR_TrackedObjectコンポーネントを取得している点に注意してください。

```

public class HandMonitor : MonoBehaviour {

	SteamVR_Controller.Device hand = null;
	Text[] texts = null;

	//------------------------------------------------------------------------------------------------------------------------------//
	void Start () {

		//親オブジェクトにアタッチされているコントローラデバイスの参照を取得
		SteamVR_TrackedObject handTO = transform.parent.GetComponent<SteamVR_TrackedObject>();
		hand = SteamVR_Controller.Input( (int) handTO.index );
		texts = transform.FindChild("Inputs").GetComponentsInChildren<Text>();
	}

	void Update () {

		// コントローラの状態をトラックする
		TrackHand ();

		// 各ボタンからの入力をトラックする
		TrackInputs ();
	}

	//------------------------------------------------------------------------------------------------------------------------------//
	void TrackHand () {
		SteamVR_Utils.RigidTransform Hand_tr = hand.transform;
		texts[0].text = "Position : " + Hand_tr.pos + "";
		texts[1].text = "Rotation : (" + Mathf.RoundToInt (Hand_tr.rot.eulerAngles.x) + " : " + Mathf.RoundToInt (Hand_tr.rot.eulerAngles.y) + " : " + Mathf.RoundToInt (Hand_tr.rot.eulerAngles.z) + ")";
	}

	void TrackInputs() {
		string ev = null;
		TrackTrigger ( ref ev );
		TrackTouchPad ( ref ev );
		TrackGrip ( ref ev );
		TrackButtons ( ref ev );
		if ( ev != null ) {
			texts [2].text = "Input : " + ev;
		}
	}

	//------------------------------------------------------------------------------------------------------------------------------//
	void TrackTrigger ( ref string ev ) {

		if (hand.GetTouchDown(SteamVR_Controller.ButtonMask.Trigger)) {
			ev = "Trigger-GetTouchDown";
		}
		if (hand.GetPressDown(SteamVR_Controller.ButtonMask.Trigger)) {
			ev = "Trigger-GetPressDown";
		}
		if (hand.GetTouchUp(SteamVR_Controller.ButtonMask.Trigger)) {
			ev = "Trigger-GetTouchUp";
		}

		//トリガーの深さを取得
		var value = hand.GetAxis (Valve.VR.EVRButtonId.k_EButton_SteamVR_Trigger);
		texts [3].text = "Trigger Depth : " + value.x;
	}

	void TrackTouchPad ( ref string ev ) {

		if (hand.GetTouchDown(SteamVR_Controller.ButtonMask.Touchpad)) {
			ev = "Touchpad-GetTouchDown";
		}
		if (hand.GetTouchUp(SteamVR_Controller.ButtonMask.Touchpad)) {
			ev = "Touchpad-GetTouchUp";
		}
		if (hand.GetPressDown(SteamVR_Controller.ButtonMask.Touchpad)) {
			ev = "Touchpad-GetPressDown";
		}

		//タッチパッドのタッチ位置を取得
		var value = hand.GetAxis (Valve.VR.EVRButtonId.k_EButton_SteamVR_Touchpad);
		texts [4].text = "Touchpad Position : " + value;
	}

	void TrackGrip ( ref string ev ) {
		if (hand.GetPressDown(SteamVR_Controller.ButtonMask.Grip)) {
			ev = "Grip-GetPressDown";
		}
	}

	void TrackButtons ( ref string ev ) {
		if (hand.GetPressDown(SteamVR_Controller.ButtonMask.ApplicationMenu)) {
			ev = "ApplicationMenu-GetPressDown";
		}
	}
}
```

---
### シーンの実行

シーンを実行すると、HMDの中央にHMDからの情報が表示され、各VIVEコントローラーモデルにコントローラーからの情報が表示されたでしょうか。
特にVIVEコントローラーの各ボタンを押したときにどういうイベントが発行されているかを確認してみてください。

![image][1073979541]

** 今回のサンプルシーンの場所 **
- git:// VR-studies/Asset/VR-studies/1_VR-monitor/Monitor.unity
