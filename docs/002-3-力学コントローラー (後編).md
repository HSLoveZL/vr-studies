
# 2-3. 力学コントローラーの実装 (後編)

![](assets/2-3-GrabController-3.gif)

** 今回のサンプルシーンの場所 **
- git:// VR-studies/Asset/VR-studies/2_VR-controller/2-3_GarbController

後編では、掴む入力UIを物理空間上に置かれた様々なオブジェクトに対して適用させるのに便利なJointコンポーネントを使用して、引き出しを実装してみたいと思います。

---
### ステージの作成

床などを含めた基本的なステージは、前編で使ったものをそのまま使用します。

シーンに3Dオブジェクトを追加してタンスを表現します。ここではCubeを組み合わせて以下のように配置してみました。

![](assets/002-3-力学コントローラー後編-35a62.png)

さらに、引き出しのコンテナ部分に力学演算を作用させるためにRigidbodyコンポーネントをアタッチします。Containerという名前で空のGameオブジェクトを作成し、各構成Cubeをまとめてその子にし、ContainerのみにRigidBodyをアタッチします。また、引き出しに重量感を出すため、MassとDragの値を少し上げておきます。

![](assets/002-3-力学コントローラー後編-eac91.png)


次に同じContainerに、引き出しの物理制約を持たせるために、Configuarable Jointコンポーネントをアタッチします。

![](assets/002-3-力学コントローラー後編-6dff4.png)

Configuarable Jointコンポーネントでは、XYZの各座標に沿って、アンカーポイントや稼働可能距離、稼働可能角度などを詳細に設定することができます。

ここでは画面手前方向が正のX座標になっているので、Anchorの座標は原点のまま、X MotionをLimitedに、そのほかの距離や角度はLockedに設定し、Linear LimitをContainerのX Scaleと同じ0.3として、引き出せるX距離に限界値を設定しています。

---
### GrabController.csの修正

掴んだ際に、掴まれたオブジェクトそのものが持つRigidbodyを操作するのではなく、指定された別のRigidbody全体を操作可能にするために、前編で作成したGrabController.csを修正します。

前編で作成したGrabController.csを、Hierarchyパネル上の[CameraRig]/Controller (right/left)にアタッチしたら、掴まれる対象となるオブジェクトが持つべきメソッドを、以下のようにIGrabControllerTargetインタフェースとして定義します。

```

public interface IGrabControllerTarget {
  Rigidbody GetTargetRigidbody();
}

```

コリジョン発生時にはこのインタフェースを実装しているオブジェクトのみをヒット対象とし、さらに
トリガーボタンが引かれた際には、Fixed Jointと接続するRigidbodyをこのインタフェース経由で取得するように修正します。

```
// コリジョンイベントの検知
void OnTriggerEnter( Collider other ) {

  // 掴めるオブジェクトが衝突した場合のみ検知する
  if ( other.gameObject.GetComponent<IGrabControllerTarget>() != null ) {
    hitObject = other.gameObject;
  }
}

// トリガーボタンイベントの検知
public void OnTriggerClicked( object sender, ClickedEventArgs e ) {

  if ( hitObject ) {

    // 剛体をジョイントにアサイン
    var grabTarget = hitObject.GetComponent<IGrabControllerTarget>();
    joint.connectedBody = grabTarget.GetTargetRigidbody();
  }
}
```

---
### GrabControllerTarget.csの作成

新規にGrabControllerTarget.csを作成し、以下のように、IGrabControllerTargetのメソッドを実装します。

```
public class GrabControllerTarget : MonoBehaviour, GrabController.IGrabControllerTarget {

	public Rigidbody rigidbody = null;

	void Awake () {
		if (rigidbody == null) {
			rigidbody =	this.GetComponent<Rigidbody> ();
		}
	}

	public Rigidbody GetTargetRigidbody() {
		return rigidbody;
	}
}

```

これを、Hierarchyパネル上のContainer内のKnobオブジェクトにアタッチし、さらにRigidbodyプロパティティに親のContainerオブジェクトのRigidbodyをアサインしてください。

![](assets/002-3-力学コントローラー後編-632f7.png)

---
### シーンの実行

シーンを実行すると、引き出しのノブ部分のみが掴めて、引っ張ると手前に引き出せて、特定距離以上引き出そうとするときちんと止まったでしょうか？

![](assets/2-3-GrabController-3.gif)

このJointコンポーネントを使えば、物理オブジェクトで必要なインタラクションは大体のものは作成できますが、よりリアルな挙動をさせたい場合などは、Jointを利用するのではなく、掴んだ物体とコントローラーとの間の力関係を独自に計算するなど物理演算そのものに手を入れる必要があるかもしれません。

以下のサンプルシーンでは、他にもさまざまなインタラクションのサンプルを作成してみましたので参考にしてください。

![](assets/000-VR-studies-概要-39c34.png)

** 今回のサンプルシーンの場所 **
- git:// VR-studies/Asset/VR-studies/2_VR-controller/2-3_GrabController
