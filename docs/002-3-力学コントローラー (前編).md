# 2-3. 力学コントローラーの実装 (前編)

![image][1073979575]

** 今回のサンプルシーンの場所 **
- git:// VR-studies/Asset/VR-studies/2_VR-controller/2-3_GarbController

今回はVR空間内に置かれたオブジェクトに対して様々な物理的なインタラクションを可能にする入力UIを実装してみたいと思います。
まずは前編では、VIVEコントローラーで物理オブジェクトを掴んで投げるための基本処理を実装してみます。


---
### 新規シーンの構築

新規シーンを作成したら、まずは前章の通りSteamVR Pluginをインポートして、[CameraRig]プレハブを配置後、MainCameraを削除します。

---
### ステージの作成

まずは床を作りますが、今回はステージ全体に物理演算を適用させるため、床のコリジョンもしっかり設定しておいたほうが良いでしょう。
シーンに3D Object/Cubeを追加し、yスケールを0ではなく少し厚めにとっておきます。

次に力学コントローラーの操作対象となるオブジェクトを作成します。シーンにPrimitiveオブジェクトを追加していきます。
ここではSphereとCubeを以下のように配置してみました。

![image][1073979574]

さらに各オブジェクトに力学演算を作用させるためにRigidbodyコンポーネントをアタッチします。
ここではSphereはUse GravityをOnにして、CubeはOffに設定してみました。

![image][1073979573]

---
### GrabController.csの作成  

次にコントローラーの基本機能を実装するスクリプトを作成します。
Projectパネル内にGrabControllerという名前でC#Scriptを作成し、Hierarchyパネル上の[CameraRig]/Controller (right/left)にアタッチします。

### 物理オブジェクトとの接触判定

物理オブジェクトとコントローラーの接触を検知するために、まずはVIVEコントローラー側にもCollider/Rigidbodyコンポーネントを設定します。
今回はStart()の中で動的にRigidbodyを作成してアタッチすることにしますが、この際、力学演算をスクリプトから操作するために、ColliderのisTriggerとRigidbodyのisKinematicをONにしておきます。
さらにRigidBodyのCollisionDetectionModeをContinuousDynamicに設定することで、衝突検知の精度を上げて衝突したオブジェクトがすり抜けないようにします。

```
void Start () {

...

  // コリジョン判定用のColliderとRigidBodyをアタッチ
  var collider = gameObject.AddComponent<SphereCollider>();
  collider.isTrigger = true; //衝突イベントを受け取るために有効化
  collider.radius = 0.06f;

  var rigid = gameObject.AddComponent<Rigidbody>();
  rigid.useGravity = false;
  rigid.isKinematic = true; //スクリプトから操作するために有効化
  rigid.collisionDetectionMode = CollisionDetectionMode.ContinuousDynamic;
```

isTriggerをtrueにすることで、VIVEコントローラーと物理オブジェクトが接触した際に、OnTiggerEnter()イベントハンドラが呼ばれるようになります。
OnTiggerEnter()では下記のように接触したオブジェクトの参照を保持しておきます。

```
// コリジョンイベントの検知
void OnTriggerEnter( Collider other ) {

  //ヒットしたオブジェクトを保持する
  hitObject = other.gameObject;
}
```

### 物理オブジェクトを掴む処理の実装

つぎに物理オブジェクトと接触した後、VIVEコントローラーのトリガーボタンを引くと、物体を掴んで持ち上げられるようにします。

まずはトリガーボタンの押下を検知するために、SteamVR Pluginにイベントハンドラを登録します。

```
  // SteamVR_TrackedControllerをアタッチして、トリガーイベントハンドラを登録
  SteamVR_TrackedController handTO = gameObject.AddComponent<SteamVR_TrackedController> ();
  handTO.TriggerClicked += new ClickedEventHandler (OnTriggerClicked);
  handTO.TriggerUnclicked += new ClickedEventHandler (OnTriggerUnclicked);
```

続けてFixedJointコンポーネントをアタッチしておきます。Jointコンポーネントを使用すると任意のRigidbody同士を繋ぐことができます。
今回はこのコンポーネントを使用して物体を掴む処理を実装します。

```
  // ジョイントをアタッチ
  joint = gameObject.AddComponent<FixedJoint> ();
```

トリガーボタンが引かれた際に呼ばれるOnTriggerClicked()内で、このJointのconnectedBodyに接触中のオブジェクトのRigidbodyをアサインして接続します。

```
// トリガーボタンイベントの検知
public void OnTriggerClicked( object sender, ClickedEventArgs e ) {

  if ( hitObject ) {

    // 剛体をジョイントにアサイン
    var rigid = hitObject.GetComponent<Rigidbody>();
    if( rigid != null ){
      joint.connectedBody = rigid;
    }
  }
}
```

さらにトリガーボタンが離されたときに、掴んでいたオブジェクトを投げられるようにするため、OnUnTriggerClicked()内でJoint解放後に力を加える処理を行います。

```
public void OnTriggerUnclicked(　object sender, ClickedEventArgs e　) {

  if ( hitObject ) {

    //掴んでいるオブジェクトにフォースを加えて投げる
    Rigidbody rigid = joint.connectedBody;
    rigid.velocity = hand.velocity;
    rigid.angularVelocity = hand.angularVelocity;

    // ジョイントを解放する
    joint.connectedBody = null;
    hitObject = null;
  }
}
```

---
### シーンの実行

シーンを実行して、SphereやCubeにVIVEコントローラーを接触させた状態でトリガーボタンを押してみてください。掴んで投げられたでしょうか。

![image][1073979575]
